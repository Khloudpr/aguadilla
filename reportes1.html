<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Reportes | Aguadilla</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .filter-btn.active{background-color:#1e3a8a;color:white;border-color:#1e3a8a}
        .sidebar-link{font-size:0.85rem;letter-spacing:0.05em;font-weight:800}
        body{min-height:100vh;display:flex;flex-direction:column;color:#1e293b;background:#f1f5f9}
        table{border-collapse:separate;border-spacing:0 8px}
        .btn-logout{transition:all 0.3s}
        .btn-logout:hover{background-color:#dc2626;transform:translateX(5px)}
        .modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.7);align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:2rem;max-width:900px;width:90%;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .command-palette{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.8);align-items:flex-start;justify-content:center;padding-top:15vh}
        .command-palette.active{display:flex}
        .quick-actions{position:fixed;bottom:30px;right:30px;z-index:50;display:flex;gap:10px}
        .quick-btn{width:56px;height:56px;border-radius:50%;background:#1e3a8a;color:white;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(30,58,138,0.4);cursor:pointer;transition:all 0.3s}
        .quick-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(30,58,138,0.6)}
        body.focus-mode .sidebar,body.focus-mode .quick-actions,body.focus-mode header{opacity:0.3;pointer-events:none}
        .breadcrumb{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em}
        .breadcrumb a{color:#64748b;transition:color 0.2s}
        .breadcrumb a:hover{color:#1e3a8a}
        .breadcrumb .current{color:#1e3a8a}
        .row-highlight{background:#fef3c7;animation:highlight 2s}
        @keyframes highlight{from{background:#fef3c7}to{background:transparent}}
        
        /* Lightbox Ultimate */
        .lightbox{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;animation:fadeIn 0.3s}
        .lightbox.active{display:flex}
        .lightbox-image{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:1rem;box-shadow:0 25px 50px rgba(0,0,0,0.5)}
        .lightbox-close{position:absolute;top:20px;right:20px;width:50px;height:50px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:all 0.3s;z-index:1000}
        .lightbox-close:hover{transform:scale(1.1);background:#f1f5f9}
        .lightbox-info{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.95);padding:1rem 2rem;border-radius:1rem;font-size:0.875rem;font-weight:700;color:#1e293b;display:flex;gap:2rem}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    </style>
</head>
<body class="bg-slate-100 font-sans">

<!-- Shortcuts Help -->
<div id="shortcuts-help" class="modal">
    <div class="modal-content p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">‚å®Ô∏è Atajos de Teclado</h2>
            <button onclick="closeShortcuts()" class="text-2xl text-slate-400 hover:text-slate-900">&times;</button>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">G</kbd><span class="ml-4">Ir a Dashboard</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">R</kbd><span class="ml-4">Ir a Reportes</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">M</kbd><span class="ml-4">Ir a Mapa</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">/</kbd><span class="ml-4">B√∫squeda r√°pida</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">F</kbd><span class="ml-4">Modo Focus</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">E</kbd><span class="ml-4">Exportar</span></div>
            <div class="flex justify-between"><kbd class="bg-slate-100 px-3 py-2 rounded font-mono">?</kbd><span class="ml-4">Ver atajos</span></div>
        </div>
    </div>
</div>

<!-- Command Palette -->
<div id="command-palette" class="command-palette">
    <div class="w-full max-w-2xl px-4">
        <input type="text" id="command-input" placeholder="üîç Buscar por ID, categor√≠a, ubicaci√≥n..." class="w-full px-6 py-4 rounded-2xl text-lg font-bold border-4 border-blue-900 outline-none" autocomplete="off">
        <div id="command-results" class="bg-white mt-2 rounded-2xl shadow-2xl max-h-96 overflow-y-auto"></div>
    </div>
</div>

<!-- Lightbox Ultimate -->
<div id="photo-lightbox" class="lightbox" onclick="closeLightbox(event)">
    <button class="lightbox-close" onclick="closeLightbox(event)">√ó</button>
    <img id="lightbox-img" src="" alt="Evidencia" class="lightbox-image">
    <div id="lightbox-info" class="lightbox-info"></div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="modal">
    <div class="modal-content">
        <div class="p-8">
            <div class="flex justify-between items-start mb-6">
                <div class="flex-1">
                    <div class="breadcrumb mb-2">
                        <a href="dashboard1.html">Dashboard</a>
                        <i class="fas fa-chevron-right text-[10px]"></i>
                        <a href="#" onclick="closeModal();return false;">Reportes</a>
                        <i class="fas fa-chevron-right text-[10px]"></i>
                        <span class="current">Detalle</span>
                    </div>
                    <h2 id="modal-title" class="text-3xl font-black text-blue-900 italic"></h2>
                </div>
                <button onclick="closeModal()" class="text-3xl text-slate-400 hover:text-slate-900 ml-4">&times;</button>
            </div>
            <div id="modal-content" class="space-y-6"></div>
            <div id="modal-actions" class="flex gap-3 mt-8"></div>
        </div>
    </div>
</div>

<!-- Mobile Menu Button -->
<button onclick="toggleMobileMenu()" class="md:hidden fixed top-4 left-4 z-50 bg-blue-900 text-white p-3 rounded-xl shadow-lg">
    <i class="fas fa-bars text-xl"></i>
</button>

<div id="mobile-overlay" onclick="toggleMobileMenu()" class="md:hidden fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity"></div>

<div class="flex flex-1">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-blue-900 text-white p-8 flex flex-col fixed md:sticky top-0 h-screen shadow-2xl z-40 -translate-x-full md:translate-x-0 transition-transform duration-300">
        <button onclick="toggleMobileMenu()" class="md:hidden absolute top-4 right-4 text-white text-2xl"><i class="fas fa-times"></i></button>

        <div class="flex items-center gap-3 mb-12">
            <div class="bg-white text-blue-900 p-1.5 rounded-lg font-black text-xl shadow-lg">AR</div>
            <span class="font-black text-xl uppercase italic tracking-tighter">Aguadilla</span>
        </div>
        
        <nav class="space-y-6 flex-1">
            <a href="dashboard1.html" class="sidebar-link flex items-center gap-4 opacity-70 hover:opacity-100 transition-all p-2">
                <i class="fas fa-chart-pie w-6 text-lg"></i> DASHBOARD
                <kbd class="ml-auto text-[9px] bg-blue-800 px-2 py-1 rounded opacity-50">G</kbd>
            </a>
            <a href="reportes1.html" class="sidebar-link flex items-center gap-4 bg-blue-800 p-4 rounded-2xl shadow-lg">
                <i class="fas fa-clipboard-list w-6 text-lg"></i> REPORTES
                <kbd class="ml-auto text-[9px] bg-blue-700 px-2 py-1 rounded">R</kbd>
            </a>
            <a href="mapa1.html" class="sidebar-link flex items-center gap-4 opacity-70 hover:opacity-100 transition-all p-2">
                <i class="fas fa-map-marked-alt w-6 text-lg"></i> MAPA
                <kbd class="ml-auto text-[9px] bg-blue-800 px-2 py-1 rounded opacity-50">M</kbd>
            </a>
        </nav>

        <!-- Recent Activity -->
        <div class="mb-6 p-4 bg-blue-800/30 rounded-xl">
            <h4 class="text-[9px] font-black uppercase tracking-widest mb-3 text-blue-300">üìå √öltima Actividad</h4>
            <div id="recent-activity" class="space-y-2 text-xs"></div>
        </div>
        
        <div class="border-t border-blue-800 pt-6 space-y-4">
            <div class="bg-blue-800/50 rounded-2xl p-4">
                <div class="flex items-center gap-3 mb-2">
                    <div class="bg-blue-700 w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-black text-white truncate" id="user-name">Empleado</p>
                        <p class="text-[9px] text-blue-300 truncate" id="user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="97f2faf6fefbd7f6f0e2f6f3fefbfbf6b9f4f8fa">[email&#160;protected]</a></p>
                    </div>
                </div>
            </div>
            
            <button onclick="cerrarSesion()" class="btn-logout w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-black text-sm uppercase tracking-wider">
                <i class="fas fa-sign-out-alt"></i>Cerrar Sesi√≥n
            </button>
        </div>
        
        <div class="pt-4 text-[10px] font-black text-blue-400 uppercase tracking-widest italic text-center">Ultimate Edition v1.0</div>
    </aside>

    <main class="flex-1 p-4 md:p-8 w-full">
        <!-- Header -->
        <header class="mb-8">
            <div class="breadcrumb mb-4">
                <a href="dashboard1.html">Dashboard</a>
                <i class="fas fa-chevron-right text-[10px]"></i>
                <span class="current">Reportes</span>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6">
                <div>
                    <h1 class="text-3xl md:text-5xl font-black text-slate-800 tracking-tighter italic uppercase">Gesti√≥n de Reportes</h1>
                    <p class="text-blue-600 font-black text-xs mt-2 uppercase tracking-[0.3em]">Consola Operativa Municipal</p>
                </div>
                
                <div class="flex gap-2 flex-wrap">
                    <button onclick="toggleFocusMode()" id="btn-focus" class="bg-white text-slate-700 px-4 py-2 rounded-xl shadow-md hover:shadow-lg transition text-xs font-black uppercase" title="Focus (F)">
                        <i class="fas fa-eye mr-2"></i><span class="hidden sm:inline">Focus</span>
                    </button>
                    <button onclick="exportarReportes()" class="bg-white text-slate-700 px-4 py-2 rounded-xl shadow-md hover:shadow-lg transition text-xs font-black uppercase" title="Exportar (E)">
                        <i class="fas fa-download mr-2"></i><span class="hidden sm:inline">Exportar</span>
                    </button>
                    <div class="bg-white px-4 py-2 rounded-2xl shadow-sm border flex items-center gap-3">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span>
                        <span class="text-[10px] font-black text-slate-500 uppercase" id="sync-status">Live</span>
                    </div>
                    <button onclick="cargarReportes()" class="bg-blue-900 text-white px-4 py-2 rounded-xl shadow-lg hover:bg-blue-800 transition text-xs font-black uppercase">
                        <i class="fas fa-sync-alt mr-2" id="sync-icon"></i><span class="hidden sm:inline">Refrescar</span>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex gap-2 flex-wrap">
                <button data-filter="Todos" class="filter-btn active px-4 py-2 rounded-xl text-xs font-black uppercase bg-slate-100 text-slate-600 border-2 border-transparent">Todos</button>
                <button data-filter="Nuevo" class="filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase bg-slate-100 text-slate-600 border-2 border-transparent">Nuevos</button>
                <button data-filter="Pendiente" class="filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase bg-slate-100 text-slate-600 border-2 border-transparent">Pendientes</button>
                <button data-filter="En Revisi√≥n" class="filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase bg-slate-100 text-slate-600 border-2 border-transparent">En Revisi√≥n</button>
                <button data-filter="Completado" class="filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase bg-slate-100 text-slate-600 border-2 border-transparent">Completados</button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">Total</p>
                <p id="stat-total" class="text-3xl font-black text-slate-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">Pendientes</p>
                <p id="stat-pendientes" class="text-3xl font-black text-orange-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">En Revisi√≥n</p>
                <p id="stat-revision" class="text-3xl font-black text-blue-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">Completados</p>
                <p id="stat-completados" class="text-3xl font-black text-green-600">0</p>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full" style="min-width:1000px">
                    <thead class="bg-slate-50">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="p-4 text-left">ID</th>
                            <th class="p-4 text-left">Ciudadano</th>
                            <th class="p-4 text-left">Categor√≠a</th>
                            <th class="p-4 text-left">Ubicaci√≥n</th>
                            <th class="p-4 text-center">Estatus</th>
                            <th class="p-4 text-center">Prioridad</th>
                            <th class="p-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-reportes" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <button class="quick-btn" onclick="openCommandPalette()" title="Buscar (/)">
        <i class="fas fa-search"></i>
    </button>
    <button class="quick-btn" onclick="showShortcuts()" title="Atajos (?)">
        <i class="fas fa-keyboard"></i>
    </button>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwf6zkn7u0PO3t9TPkVG2NjoDwRF7-BuSAtP4T0PXaDStulKQBJOXqzWFwm5Nqh6LP-jA/exec";
let allReportes=[],filteredReportes=[],currentFilter='Todos',focusMode=false,userSession=null;

window.onload = function() {
    verificarSesion();
    cargarReportes();
    setupFilters();
    setupKeyboardShortcuts();
    updateRecentActivity();
    checkURLParams();
};

function verificarSesion() {
    userSession = JSON.parse(localStorage.getItem('user_session') || 'null');
    if (!userSession || !userSession.email) {
        window.location.href = 'login.html';
        return;
    }
    if (userSession.rol !== 'empleado' && userSession.rol !== 'admin') {
        window.location.href = 'login.html';
        return;
    }
    document.getElementById('user-name').textContent = `${userSession.nombre} ${userSession.apellido}`;
    document.getElementById('user-email').textContent = userSession.email;
}

function cerrarSesion() {
    if (confirm('¬øCerrar sesi√≥n?')) {
        localStorage.removeItem('user_session');
        window.location.href = 'login.html';
    }
}

function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    sidebar.classList.toggle('-translate-x-full');
    sidebar.classList.toggle('translate-x-0');
    overlay.classList.toggle('opacity-0');
    overlay.classList.toggle('pointer-events-none');
    overlay.classList.toggle('opacity-100');
    overlay.classList.toggle('pointer-events-auto');
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
        switch (e.key.toLowerCase()) {
            case 'g': window.location.href = 'dashboard1.html'; break;
            case 'r': window.location.href = 'reportes1.html'; break;
            case 'm': window.location.href = 'mapa1.html'; break;
            case '/': e.preventDefault(); openCommandPalette(); break;
            case 'f': toggleFocusMode(); break;
            case 'e': exportarReportes(); break;
            case '?': showShortcuts(); break;
            case 'escape': closeModal(); closeCommandPalette(); break;
        }
    });
}

function showShortcuts() {
    document.getElementById('shortcuts-help').classList.add('active');
}

function closeShortcuts() {
    document.getElementById('shortcuts-help').classList.remove('active');
}

function openCommandPalette() {
    document.getElementById('command-palette').classList.add('active');
    document.getElementById('command-input').focus();
    updateCommandResults('');
}

function closeCommandPalette() {
    document.getElementById('command-palette').classList.remove('active');
    document.getElementById('command-input').value = '';
}

document.getElementById('command-input')?.addEventListener('input', e => updateCommandResults(e.target.value));

function updateCommandResults(query) {
    if (!query) {
        const html = `
<div onclick="window.location.href='dashboard1.html'" class="p-4 hover:bg-slate-50 cursor-pointer flex items-center gap-3 border-b"><i class="fas fa-chart-pie text-blue-900"></i><span class="font-bold text-sm">Ir a Dashboard</span></div>
<div onclick="window.location.href='mapa1.html'" class="p-4 hover:bg-slate-50 cursor-pointer flex items-center gap-3 border-b"><i class="fas fa-map-marked-alt text-blue-900"></i><span class="font-bold text-sm">Ir a Mapa</span></div>
<div onclick="exportarReportes();closeCommandPalette()" class="p-4 hover:bg-slate-50 cursor-pointer flex items-center gap-3 border-b"><i class="fas fa-download text-blue-900"></i><span class="font-bold text-sm">Exportar Reportes</span></div>
`;
        document.getElementById('command-results').innerHTML = html;
        return;
    }
    const matches = allReportes.filter(r =>
        r.id_reporte.toLowerCase().includes(query.toLowerCase()) ||
        (r.categor√≠a && r.categor√≠a.toLowerCase().includes(query.toLowerCase())) ||
        (r.ubicaci√≥n && r.ubicaci√≥n.toLowerCase().includes(query.toLowerCase())) ||
        (r.usuario && r.usuario.toLowerCase().includes(query.toLowerCase()))
    );
    const html = matches.slice(0, 8).map(r => `
<div onclick="showReporteDetail('${r.id_reporte}');closeCommandPalette()" class="p-4 hover:bg-slate-50 cursor-pointer border-b">
    <div class="font-black text-sm text-blue-900">${r.id_reporte}</div>
    <div class="text-xs text-slate-600">${r.categor√≠a || 'Sin categor√≠a'} ‚Ä¢ ${r.ubicaci√≥n || 'Sin ubicaci√≥n'}</div>
</div>`).join('') || '<div class="p-4 text-center text-slate-400">No se encontraron resultados</div>';
    document.getElementById('command-results').innerHTML = html;
}

function toggleFocusMode() {
    focusMode = !focusMode;
    document.body.classList.toggle('focus-mode');
    const btn = document.getElementById('btn-focus');
    if (focusMode) {
        btn.classList.remove('bg-white', 'text-slate-700');
        btn.classList.add('bg-blue-900', 'text-white');
        btn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i><span class="hidden sm:inline">Exit Focus</span>';
    } else {
        btn.classList.remove('bg-blue-900', 'text-white');
        btn.classList.add('bg-white', 'text-slate-700');
        btn.innerHTML = '<i class="fas fa-eye mr-2"></i><span class="hidden sm:inline">Focus</span>';
    }
}

function updateRecentActivity() {
    const activity = (localStorage.getItem('recent_activity') || '').split(',').filter(Boolean).slice(0, 3);
    const html = activity.map(id => `<div class="text-blue-300 hover:text-white cursor-pointer" onclick="showReporteDetail('${id}')"><i class="fas fa-file-alt mr-2 text-[10px]"></i>${id}</div>`).join('');
    document.getElementById('recent-activity').innerHTML = html || '<p class="text-blue-400 text-[10px]">Sin actividad</p>';
}

function addToRecentActivity(id) {
    const activity = (localStorage.getItem('recent_activity') || '').split(',').filter(Boolean);
    activity.unshift(id);
    localStorage.setItem('recent_activity', [...new Set(activity)].slice(0, 10).join(','));
    updateRecentActivity();
}

function checkURLParams() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id) {
        setTimeout(() => showReporteDetail(id), 500);
    }
}

function setupFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        aplicarFiltro();
    }));
}

async function cargarReportes() {
    const syncIcon = document.getElementById('sync-icon');
    syncIcon.classList.add('fa-spin');
    try {
        const res = await fetch(SCRIPT_URL);
        allReportes = await res.json();
        console.log('Reportes cargados:', allReportes);
        aplicarFiltro();
        const ahora = new Date();
        document.getElementById('sync-status').textContent = ahora.getHours() + ':' + ahora.getMinutes().toString().padStart(2, '0');
    } catch (e) {
        console.error('Error cargando reportes:', e);
        alert('Error al cargar reportes');
    } finally {
        syncIcon.classList.remove('fa-spin');
    }
}

function aplicarFiltro() {
    if (currentFilter === 'Todos') {
        filteredReportes = allReportes;
    } else {
        filteredReportes = allReportes.filter(r => r.estatus === currentFilter);
    }
    updateStats();
    renderTabla();
}

function updateStats() {
    document.getElementById('stat-total').textContent = filteredReportes.length;
    document.getElementById('stat-pendientes').textContent = allReportes.filter(r => r.estatus === 'Pendiente').length;
    document.getElementById('stat-revision').textContent = allReportes.filter(r => r.estatus === 'En Revisi√≥n').length;
    document.getElementById('stat-completados').textContent = allReportes.filter(r => r.estatus === 'Completado').length;
}

function renderTabla() {
    const html = filteredReportes.map(r => {
        const idLimpio = String(r.id_reporte).replace('AG-','');
        return `
<tr class="border-b hover:bg-slate-50 transition" id="row-${idLimpio}">
    <td class="p-4">
        <span class="text-blue-900 font-black italic uppercase text-xs cursor-pointer hover:underline" onclick="showReporteDetail('${r.id_reporte}')">${r.id_reporte}</span>
    </td>
    <td class="p-4 text-xs font-bold">${r.usuario || 'Sin nombre'}</td>
    <td class="p-4 text-xs">${r.categor√≠a || r.categoria || 'Sin categor√≠a'}</td>
    <td class="p-4 text-xs text-slate-500">${r.ubicaci√≥n || r.ubicacion || 'Sin ubicaci√≥n'}</td>
    <td class="p-4 text-center">
        <select id="sel-${idLimpio}" class="px-3 py-1 rounded-full text-[10px] font-black uppercase border-2 ${getEstatusColor(r.estatus)}" onchange="markChanged('${idLimpio}')">
            <option value="Nuevo" ${r.estatus === 'Nuevo' ? 'selected' : ''}>Nuevo</option>
            <option value="Pendiente" ${r.estatus === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
            <option value="En Revisi√≥n" ${r.estatus === 'En Revisi√≥n' ? 'selected' : ''}>En Revisi√≥n</option>
            <option value="Completado" ${r.estatus === 'Completado' ? 'selected' : ''}>Completado</option>
        </select>
    </td>
    <td class="p-4 text-center">
        <select id="prio-${idLimpio}" class="px-3 py-1 rounded-full text-[10px] font-black uppercase border-2 ${getPrioridadColor(r.prioridad || 'Media')}" onchange="markChanged('${idLimpio}')">
            <option value="Baja" ${r.prioridad === 'Baja' ? 'selected' : ''}>Baja</option>
            <option value="Media" ${(!r.prioridad || r.prioridad === 'Media') ? 'selected' : ''}>Media</option>
            <option value="Alta" ${r.prioridad === 'Alta' ? 'selected' : ''}>Alta</option>
        </select>
    </td>
    <td class="p-4 text-center">
        <button id="btn-${idLimpio}" onclick="actualizar('${r.id_reporte}')" class="bg-blue-900 text-white px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-blue-800 transition">SAVE</button>
    </td>
</tr>`;
    }).join('');
    document.getElementById('tabla-reportes').innerHTML = html || '<tr><td colspan="7" class="p-8 text-center text-slate-400 font-bold">No hay reportes</td></tr>';
}

function getEstatusColor(estatus) {
    const colors = {
        'Nuevo': 'bg-red-50 text-red-600 border-red-200',
        'Pendiente': 'bg-orange-50 text-orange-600 border-orange-200',
        'En Revisi√≥n': 'bg-blue-50 text-blue-600 border-blue-200',
        'Completado': 'bg-green-50 text-green-600 border-green-200'
    };
    return colors[estatus] || 'bg-slate-50 text-slate-600 border-slate-200';
}

function getPrioridadColor(prioridad) {
    const colors = {
        'Baja': 'bg-slate-50 text-slate-600 border-slate-200',
        'Media': 'bg-yellow-50 text-yellow-700 border-yellow-200',
        'Alta': 'bg-red-50 text-red-600 border-red-200'
    };
    return colors[prioridad] || colors['Media'];
}

function markChanged(id) {
    const btn = document.getElementById(`btn-${id}`);
    btn.classList.remove('bg-blue-900');
    btn.classList.add('bg-green-600', 'animate-pulse');
    btn.innerHTML = '<i class="fas fa-save mr-1"></i>GUARDAR';
}

async function actualizar(id) {
    const btn = event.currentTarget;
    const idLimpio = String(id).replace('AG-', '');
    const estatusElement = document.getElementById(`sel-${idLimpio}`);
    const prioridadElement = document.getElementById(`prio-${idLimpio}`);
    
    if (!estatusElement || !prioridadElement) {
        alert('Error: elementos no encontrados');
        return;
    }
    
    const estatus = estatusElement.value;
    const prioridad = prioridadElement.value;
    const usuario = userSession ? userSession.email : 'Desconocido';
    
    btn.innerHTML = '<i class="fas fa-sync fa-spin"></i>';
    btn.disabled = true;
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'updateStatus',
                id,
                estatus,
                prioridad,
                usuario
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (data.result === 'success') {
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.remove('bg-green-600', 'animate-pulse');
            btn.classList.add('bg-green-700');
            setTimeout(() => {
                btn.innerHTML = 'SAVE';
                btn.classList.remove('bg-green-700');
                btn.classList.add('bg-blue-900');
                btn.disabled = false;
            }, 2000);
            const row = document.getElementById(`row-${idLimpio}`);
            if (row) {
                row.classList.add('row-highlight');
            }
        } else {
            throw new Error(data.message || 'Error');
        }
    } catch (error) {
        console.error(error);
        alert('Error al actualizar');
        btn.innerHTML = 'SAVE';
        btn.disabled = false;
    }
}

function showReporteDetail(id) {
    addToRecentActivity(id);
    const reporte = allReportes.find(r => r.id_reporte === id);
    if (!reporte) {
        alert('Reporte no encontrado');
        return;
    }
    document.getElementById('modal-title').textContent = id;
    const content = `
<div class="grid grid-cols-2 gap-4">
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Ciudadano</p><p class="text-sm font-bold">${reporte.usuario || 'Sin nombre'}</p></div>
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Email</p><p class="text-sm">${reporte.email || 'Sin email'}</p></div>
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Categor√≠a</p><p class="text-sm font-bold">${reporte.categor√≠a || reporte.categoria || 'Sin categor√≠a'}</p></div>
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Prioridad</p><p class="text-sm font-bold">${reporte.prioridad || 'Media'}</p></div>
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Estatus</p><p class="text-sm font-bold">${reporte.estatus}</p></div>
    <div><p class="text-xs font-black text-slate-400 uppercase mb-1">Fecha</p><p class="text-sm">${new Date(reporte.fecha).toLocaleDateString('es-PR')}</p></div>
    <div class="col-span-2"><p class="text-xs font-black text-slate-400 uppercase mb-1">Ubicaci√≥n</p><p class="text-sm font-bold">${reporte.ubicaci√≥n || reporte.ubicacion || 'Sin ubicaci√≥n'}</p></div>
    <div class="col-span-2"><p class="text-xs font-black text-slate-400 uppercase mb-1">Descripci√≥n</p><p class="text-sm">${reporte.descripci√≥n || reporte.descripcion || 'Sin descripci√≥n'}</p></div>
    ${reporte.foto_url ? `<div class="col-span-2">
        <p class="text-xs font-black text-slate-400 uppercase mb-3">Evidencia Fotogr√°fica</p>
        <div class="bg-slate-50 rounded-xl p-4 border-2 border-slate-200">
            <img src="${reporte.foto_url}" alt="Preview" class="w-48 h-48 object-cover rounded-lg mb-3 cursor-pointer hover:opacity-80 transition" onclick="openLightbox('${reporte.foto_url}', '${reporte.id_reporte}', '${reporte.fecha}')">
            <button onclick="openLightbox('${reporte.foto_url}', '${reporte.id_reporte}', '${reporte.fecha}')" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl font-black text-sm hover:from-blue-700 hover:to-purple-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-search-plus"></i>
                Ver en Pantalla Completa
            </button>
        </div>
    </div>` : ''}
    ${reporte.latitud && reporte.longitud ? `<div class="col-span-2"><p class="text-xs font-black text-slate-400 uppercase mb-1">Coordenadas GPS</p><p class="text-sm font-mono">${reporte.latitud}, ${reporte.longitud}</p><button onclick="window.open('https://www.google.com/maps?q=${reporte.latitud},${reporte.longitud}','_blank')" class="mt-2 text-xs text-blue-900 font-bold hover:underline"><i class="fas fa-map-marker-alt mr-1"></i>Ver en Google Maps</button></div>` : ''}
</div>`;
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-actions').innerHTML = '<button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-black uppercase text-sm hover:bg-slate-200 transition">Cerrar</button>';
    document.getElementById('detail-modal').classList.add('active');
}

function closeModal() {
    document.getElementById('detail-modal').classList.remove('active');
}

function exportarReportes() {
    let csv = 'ID,Ciudadano,Categoria,Ubicacion,Estatus,Prioridad,Fecha\n';
    filteredReportes.forEach(r => csv += `${r.id_reporte},"${r.usuario || ''}","${r.categor√≠a || r.categoria}","${r.ubicaci√≥n || r.ubicacion}",${r.estatus},${r.prioridad || 'Media'},${r.fecha}\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `aguadilla-reportes-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

document.getElementById('detail-modal')?.addEventListener('click', e => {
  
function openLightbox(url, id, fecha) {
    document.getElementById('lightbox-img').src = url;
    document.getElementById('lightbox-info').innerHTML = `
        <span><i class="fas fa-hashtag mr-1"></i>${id}</span>
        <span><i class="fas fa-calendar mr-1"></i>${new Date(fecha).toLocaleDateString('es-PR')}</span>
    `;
    document.getElementById('photo-lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox(event) {
    if (event.target.id === 'photo-lightbox' || event.target.classList.contains('lightbox-close')) {
        document.getElementById('photo-lightbox').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeLightbox({target: {id: 'photo-lightbox'}});
    }
});
</script>
</body>
</html>
